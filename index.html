<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>D3 CSV</title>

</head>
<body>
<div>
<h4>Research results: </h4>
<div id="cloud" >
	
</div>
</div>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="d3.layout.cloud.js"></script>
 <script src="http://d3js.org/colorbrewer.v1.min.js"></script>
<script type="text/javascript">

var fill = d3.scale.category20();

var asiaExpert = {};
var asiaNonExpert = {};
var europeExpert = {};
var europeNonExpert = {};
var americaExpert = {};
var americaNonExpert = {};
var australiaExpert = {};
var australiaNonExpert = {};


var countriesContinents = {};
countriesContinents["usa"] = "America";
countriesContinents["canada"] = "America";
countriesContinents["mexico"] = "America";
countriesContinents["lc"] = "America";
countriesContinents["finland"] = "Europe";
countriesContinents["norway"] = "Europe";
countriesContinents["estonia"] = "Europe";
countriesContinents["belarus"] = "Europe";
countriesContinents["latvia"] = "Europe";
countriesContinents["cloveniya"] = "Europe";
countriesContinents["republic of belarus"] = "Europe";
countriesContinents["slovenia"] = "Europe";
countriesContinents["serbia"] = "Europe";
countriesContinents["ukraine"] = "Asia";
countriesContinents["austria"] = "Asia";
countriesContinents["israel"] = "Asia";
countriesContinents["south korea"] = "Asia";
countriesContinents["russia"] = "Asia";
countriesContinents["russian federation"] = "Asia";
countriesContinents["moscow"] = "Asia";
countriesContinents["russia tatarstan"] = "Asia";
countriesContinents["the ussr"] = "Asia";
countriesContinents["australia"] = "Australia";


var wordAvgAge = {};

var height = window.innerHeight;
var width = window.innerWidth;

var dogResearchData = [];
var forbbidenWords = ["a","and","then","with","on","the","it","he","or","in","to","she","-","do","does","his","are","for", "is", "by", "at", "what", "of","some", "not","too","every","was","such",
"be", "as", "but"];
d3.csv("outputNew.csv", function(data) {
    // build the list of city names
    data.forEach( function (d) {
        d.word = d.word.toLowerCase();
        if (forbbidenWords.indexOf(d.word) == -1 )
        {
            d.word = stemmer(d.word);
            dogResearchData.push({word: d.word, location: d.location, education: d.education, age : d.age});
        }
    });

for (var i=0; i < dogResearchData.length; i++)  {
    var d = dogResearchData[i];
    d.location  = d.location.toLowerCase();
    if(d.location in countriesContinents)//if this word already exists
        {
            if(countriesContinents[d.location]  == "America")
            {
                if(d.education == "dog Owner")
                {
                    if(d.word in americaNonExpert)
                        americaNonExpert[d.word]++;
                    else
                        americaNonExpert[d.word] = 1;
                }
                else
                {
                    if(d.word in americaExpert)
                        americaExpert[d.word]++;
                    else
                        americaExpert[d.word] = 1;
                }
            }
            else if(countriesContinents[d.location]  == "Asia")
            {
                if(d.education == "dog Owner")
                {
                    if(d.word in asiaNonExpert)
                        asiaNonExpert[d.word]++;
                    else
                        asiaNonExpert[d.word] = 1;
                }
                else
                {
                    if(d.word in asiaExpert)
                        asiaExpert[d.word]++;
                    else
                        asiaExpert[d.word] = 1;
                }
            }
            else if(countriesContinents[d.location]  == "Europe")
            {
                if(d.education == "dog Owner")
                {
                    if(d.word in europeNonExpert)
                        europeNonExpert[d.word]++;
                    else
                        europeNonExpert[d.word] = 1;
                }
                else
                {
                    if(d.word in europeExpert)
                        europeExpert[d.word]++;
                    else
                        europeExpert[d.word] = 1;
                }
            }

            else if(countriesContinents[d.location]  == "Australia")
            {
                if(d.education == "dog Owner")
                {
                    if(d.word in australiaNonExpert)
                        australiaNonExpert[d.word]++;
                    else
                        australiaNonExpert[d.word] = 1;
                }
                else
                {
                    if(d.word in australiaExpert)
                        australiaExpert[d.word]++;
                    else
                        australiaExpert[d.word] = 1;
                }
            }

        if(d.word in wordAvgAge)
        {
            var avgAge = +wordAvgAge[d.word].avgAge * +wordAvgAge[d.word].peopleCounter;
            avgAge =  avgAge + +d.age;
            avgAge = avgAge/(wordAvgAge[d.word].peopleCounter+1);

            wordAvgAge[d.word].avgAge = avgAge;
            wordAvgAge[d.word].peopleCounter = wordAvgAge[d.word].peopleCounter+1;
        }
        else
        {
            wordAvgAge[d.word] = ({
                avgAge: +d.age,
                peopleCounter: 1
            });   
        }

        }
        
}

var wordsAsianNonExpert = d3.entries(asiaNonExpert);

var xScale1 = d3.scale.linear()
           .domain([0, d3.max(wordsAsianNonExpert, function(d) {
              return d.value;
            })
           ])
           .range([10,width/17]);


    d3.layout.cloud().size([700, 700])
        .words(wordsAsianNonExpert)
        .rotate(function() { return ~~(Math.random() * 2) * 90; })
        .padding(10)
        .font("Impact")
        .spiral("archimedean")
        .fontSize(function(d) { return xScale1(+d.value); })
        .text(function(d) { return d.key; })
        .on("end", draw)
        .start();

var wordsAsianExpert = d3.entries(asiaExpert);

var xScale4 = d3.scale.linear()
           .domain([0, d3.max(wordsAsianExpert, function(d) {
              return d.value;
            })
           ])
           .range([10,width/17]);
// var wordsAsianExpert = buildWords(asiaExpert); 

    d3.layout.cloud().size([700, 700])
        .words(wordsAsianExpert)
        .rotate(function() { return ~~(Math.random() * 2) * 90; })
        .padding(10)
        .font("Impact")
        .spiral("archimedean")
        .fontSize(function(d) { return xScale4(+d.value); })
        .text(function(d) { return d.key; })
        .on("end", draw)
        .start();


var wordsAmericanNonExpert = d3.entries(americaNonExpert);

var xScale2 = d3.scale.linear()
           .domain([0, d3.max(wordsAmericanNonExpert, function(d) {
              return d.value;
            })
           ])
           .range([10,width/17]);

 //var wordsAmericanNonExpert = buildWords(americaNonExpert); 

    d3.layout.cloud().size([700, 700])
        .words(wordsAmericanNonExpert)
        .rotate(function() { return ~~(Math.random() * 2) * 90; })
        .padding(10)
        .font("Impact")
        .spiral("archimedean")
        .fontSize(function(d) { return xScale2(+d.value); })
        .text(function(d) { return d.key; })
        .on("end", draw)
        .start();

var wordsAmericanExpert = d3.entries(americaExpert);

var xScale5 = d3.scale.linear()
           .domain([0, d3.max(wordsAmericanExpert, function(d) {
              return d.value;
            })
           ])
           .range([10,width/17]);

 //var wordsAmericanExpert = buildWords(americaExpert); 

    d3.layout.cloud().size([700, 700])
        .words(wordsAmericanExpert)
        .rotate(function() { return ~~(Math.random() * 2) * 90; })
        .padding(10)
        .font("Impact")
        .spiral("archimedean")
        .fontSize(function(d) { return xScale5(+d.value); })
        .text(function(d) { return d.key; })
        .on("end", draw)
        .start();


var wordsEuropeNonExpert = d3.entries(europeNonExpert);

var xScale3 = d3.scale.linear()
           .domain([0, d3.max(wordsEuropeNonExpert, function(d) {
              return d.value;
            })
           ])
           .range([10,width/17]);

 //var wordsEuropeNonExpert = buildWords(europeNonExpert); 

    d3.layout.cloud().size([700, 700])
        .words(wordsEuropeNonExpert)
        .rotate(function() { return ~~(Math.random() * 2) * 90; })
        .padding(10)
        .font("Impact")
        .spiral("archimedean")
        .fontSize(function(d) { return xScale3(+d.value); })
        .text(function(d) { return d.key; })
        .on("end", draw)
        .start();

var wordsEuropeExpert = d3.entries(europeExpert);

var xScale6 = d3.scale.linear()
           .domain([0, d3.max(wordsEuropeExpert, function(d) {
              return d.value;
            })
           ])
           .range([10,width/17]);
// var wordsEuropeExpert = buildWords(europeExpert); 

    d3.layout.cloud().size([700, 700])
        .words(wordsEuropeExpert)
        .rotate(function() { return ~~(Math.random() * 2) * 90; })
        .padding(10)
        .font("Impact")
        .spiral("archimedean")
        .fontSize(function(d) { return xScale6(+d.value); })
        .text(function(d) { return d.key; })
        .on("end", draw)
        .start();

 var wordsAustraliaNonExpert = d3.entries(australiaNonExpert);

var xScale7 = d3.scale.linear()
           .domain([0, d3.max(wordsAustraliaNonExpert, function(d) {
              return d.value;
            })
           ])
           .range([10,width/17]);

    d3.layout.cloud().size([700, 700])
        .words(wordsAustraliaNonExpert)
        .rotate(function() { return ~~(Math.random() * 2) * 90; })
        .padding(10)
        .font("Impact")
        .spiral("archimedean")
        .fontSize(function(d) { return xScale7(+d.value); })
        .text(function(d) { return d.key; })
        .on("end", draw)
        .start();

var wordsAustraliaExpert = d3.entries(australiaExpert);

var xScale8 = d3.scale.linear()
           .domain([0, d3.max(wordsAustraliaExpert, function(d) {
              return d.value;
            })
           ])
           .range([10,width/17]);

    d3.layout.cloud().size([700, 700])
        .words(wordsAustraliaExpert)
        .rotate(function() { return ~~(Math.random() * 2) * 90; })
        .padding(10)
        .font("Impact")
        .spiral("archimedean")
        .fontSize(function(d) { return xScale8(+d.value); })
        .text(function(d) { return d.key; })
        .on("end", draw)
        .start();



});


var color_scale = d3.scale.linear().domain([1, 50, 100]).range(["green", "red", "blue"]);

var colorScale = d3.scale.quantize()
    .range(colorbrewer.YlGnBu[8])
    .domain([0, 100]);

function draw(words) {

/*var maxAvgAge = d3.max(wordAvgAge,function(d){ return +d.value.avgAge});
var minAvgAge = d3.min(wordAvgAge,function(d){ return +d.value.avgAge});
var centerAvgAge = (maxAvgAge + minAvgAge)/2;


var color = d3.scale.linear()
    .domain([minAvgAge, centerAvgAge, maxAvgAge])
    .range(["red", "white", "green"]);//define your gradient range colors
    */

d3.select("#cloud").append("svg")
    .attr("width", (width/2 - 20))
    .attr("height", 700)
    .append("g")
    .attr("transform", "translate(" + [(width/2 - 20) >> 1, 700 >> 1] + ")")
    .selectAll("text")
    .data(words)
    .enter().append("text")
    .style("font-size", function(d) { return d.size + "px"; })
    .style("font-family", "Impact")
    .style("fill", function(d, i) { return colorScale(wordAvgAge[d.text].avgAge); })
    .attr("text-anchor", "middle")
    .attr("transform", function(d) {
        return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
    })
    .text(function(d) { return d.text; })
    .on("mouseenter", function(d){d3.select(this).style("font-size", d.size + 20 +"px" );
        d3.select(this).style("fill", "black" );
        })
    .on("mouseleave", function(d){d3.select(this).style("font-size", d.size +"px" );
        d3.select(this).style("fill", function(d, i) { return colorScale(wordAvgAge[d.text].avgAge); });
        });
}   

function colors(n) {
  var colores_g = ["#3366cc", "#dc3912", "#ff9900", "#109618", "#990099", "#0099c6", "#dd4477", "#66aa00", "#b82e2e", "#316395", "#994499", "#22aa99", "#aaaa11", "#6633cc", "#e67300", "#8b0707", "#651067", "#329262", "#5574a6", "#3b3eac"];
  return colores_g[n % colores_g.length];
}

function buildWords(wordsHash){
var words = [];
    for (var i in wordsHash) {
        words.push(i)
    //console.log('Key is: ' + i + '. Value is: ' + a_hashMap[i]);
    } 

return words;
}

var stemmer = (function(){

var exceptions = {
    skis    : 'ski'   ,
    skies   : 'sky'   ,
    dying   : 'die'   ,
    lying   : 'lie'   ,
    tying   : 'tie'   ,
    idly    : 'idl'   ,
    gently  : 'gentl' ,
    ugly    : 'ugli'  ,
    early   : 'earli' ,
    only    : 'onli'  ,
    singly  : 'singl' ,
    sky     : 'sky'   ,
    news    : 'news'  ,
    howe    : 'howe'  ,
    atlas   : 'atlas' ,
    cosmos  : 'cosmos',
    bias    : 'bias'  ,
    andes   : 'andes'

}, exceptions1a = {
    inning  : 'inning' ,
    outing  : 'outing' , 
    canning : 'canning',
    herring : 'herring',
    earring : 'earring',
    proceed : 'proceed',
    exceed  : 'exceed' ,
    succeed : 'succeed'

}, extensions2 = {
    ization : 'ize' , 
    fulness : 'ful' , 
    iveness : 'ive' , 
    ational : 'ate' , 
    ousness : 'ous' ,  
    tional  : 'tion', 
    biliti  : 'ble' , 
    lessli  : 'less', 
    entli   : 'ent' , 
    ation   : 'ate' , 
    alism   : 'al'  , 
    aliti   : 'al'  , 
    ousli   : 'ous' , 
    iviti   : 'ive' , 
    fulli   : 'ful' , 
    enci    : 'ence', 
    anci    : 'ance', 
    abli    : 'able', 
    izer    : 'ize' , 
    ator    : 'ate' , 
    alli    : 'al'  , 
    bli     : 'ble' , 
    ogi     : 'og'  , 
    li      : ''
};

module.exports = function(word){
    if(word.length < 3){ return word; }
    if(exceptions[word]){ return exceptions[word]; }

    var eRx = ['', ''],
       word = word.toLowerCase().replace(/^'/, '').replace(/[^a-z']/g, '').replace(/^y|([aeiouy])y/g, '$1Y'),
              R1, res;

    if(res = /^(gener|commun|arsen)/.exec(word)){
        R1 = res[0].length;
    }else{
        R1 = ((/[aeiouy][^aeiouy]/.exec(' '+word) || eRx).index || 1000) + 1;
    }

    var R2 = (((/[aeiouy][^aeiouy]/.exec(' '+word.substr(R1)) || eRx).index || 1000)) + R1 + 1;


    // step 0
    word = word.replace(/('s'?|')$/, '');


    // step 1a
    rx = /(?:(ss)es|(..i)(?:ed|es)|(us)|(ss)|(.ie)(?:d|s))$/;
    if(rx.test(word)){
        word = word.replace(rx, '$1$2$3$4$5');
    }else{
        word = word.replace(/([aeiouy].+)s$/, '$1');
    }

    if(exceptions1a[word]){ return exceptions1a[word]; }

    // step 1b
    var s1 = (/(eedly|eed)$/.exec(word) || eRx)[1],
        s2 = (/(?:[aeiouy].*)(ingly|edly|ing|ed)$/.exec(word) || eRx)[1];

    if(s1.length > s2.length){
        if(word.indexOf(s1, R1)>=0){
            word = word.substr(0, word.length - s1.length) + 'ee';
        }
    }else if(s2.length > s1.length){
        word = word.substr(0, word.length - s2.length);
        if(/(at|bl|iz)$/.test(word)){
            word += 'e';
        }else if(/(bb|dd|ff|gg|mm|nn|pp|rr|tt)$/.test(word)){
            word = word.substr(0, word.length - 1);
        }else if(!word.substr(R1) && /([^aeiouy][aeiouy][^aeiouywxY]|^[aeiouy][^aeiouy]|^[aeiouy])$/.test(word)){
            word += 'e';
        }
    }


    // step 1c
    word = word.replace(/(.[^aeiouy])[yY]$/, '$1i');


    // step 2
    var sfx = /(ization|fulness|iveness|ational|ousness|tional|biliti|lessli|entli|ation|alism|aliti|ousli|iviti|fulli|enci|anci|abli|izer|ator|alli|bli|l(ogi)|[cdeghkmnrt](li))$/.exec(word);
    if(sfx){
        sfx  = sfx[3] || sfx[2] || sfx[1];
        if(word.indexOf(sfx, R1) >= 0){
            word = word.substr(0, word.length - sfx.length) + extensions2[sfx];
        }
    }


    // step 3
    var sfx = (/(ational|tional|alize|icate|iciti|ative|ical|ness|ful)$/.exec(word) || eRx)[1];
    if(sfx && (word.indexOf(sfx, R1) >= 0)){
        word = word.substr(0, word.length - sfx.length) + {
            ational : 'ate',
            tional  : 'tion',
            alize   : 'al',
            icate   : 'ic',
            iciti   : 'ic',
            ative   : ((word.indexOf('ative', R2) >= 0) ? '' : 'ative'),
            ical    : 'ic',
            ness    : '',
            ful     : ''
        }[sfx];
    }


    // step 4
    var sfx = /(ement|ance|ence|able|ible|ment|ant|ent|ism|ate|iti|ous|ive|ize|[st](ion)|al|er|ic)$/.exec(word);
    if(sfx){
        sfx = sfx[2] || sfx[1];
        if(word.indexOf(sfx, R2) >= 0){
            word = word.substr(0, word.length - sfx.length);
        }
    }


    // step 5
    if(word.substr(-1) == 'e'){
        if(word.substr(R2) || (word.substr(R1) && !(/([^aeiouy][aeiouy][^aeiouywxY]|^[aeiouy][^aeiouy])e$/.test(word)))){
            word = word.substr(0, word.length - 1);
        }
        
    }else if((word.substr(-2) == 'll') && (word.indexOf('l', R2) >= 0)){
        word = word.substr(0, word.length - 1);
    }

    return word.toLowerCase();
};
})();

</script>
</body>
</html>